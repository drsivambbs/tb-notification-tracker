rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user data from Firestore
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin_user';
    }
    
    // Helper function to check if user is PHC user
    function isPhcUser() {
      return isAuthenticated() && getUserData().role == 'phc_user';
    }
    
    // Helper function to check if user is STS user
    function isStsUser() {
      return isAuthenticated() && getUserData().role == 'sts_user';
    }
    
    // Helper function to check if user is active
    function isActiveUser() {
      return isAuthenticated() && getUserData().is_active == true;
    }
    
    // Users collection rules
    match /users/{userId} {
      // All authenticated users can read user documents
      allow read: if isAuthenticated();
      
      // Only admin users can create, update, or delete users
      allow create, update, delete: if isAdmin();
    }
    
    // Cases collection rules
    match /cases/{caseId} {
      // Read access based on role
      allow read: if isAuthenticated() && isActiveUser() && (
        // Admin can read all cases
        isAdmin() ||
        // PHC user can only read cases from their own PHC
        (isPhcUser() && resource.data.phc_name == getUserData().phc_name) ||
        // STS user can only read cases from their assigned PHC
        (isStsUser() && resource.data.phc_name == getUserData().phc_name)
      );
      
      // Only PHC users can create cases
      allow create: if isPhcUser() && isActiveUser() &&
        // Ensure PHC name matches the user's PHC
        request.resource.data.phc_name == getUserData().phc_name &&
        // Ensure created_by_user_id matches the authenticated user
        request.resource.data.created_by_user_id == request.auth.uid &&
        // Ensure case_status is set to "Processing" on creation
        request.resource.data.case_status == 'Processing';
      
      // STS users can update cases, but only specific fields
      allow update: if isStsUser() && isActiveUser() &&
        // Case must be from their assigned PHC
        resource.data.phc_name == getUserData().phc_name &&
        // Only allow updates to these specific fields
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['case_status', 'nikshay_id', 'status_updated_by', 'status_updated_at']) &&
        // Ensure status_updated_by is set to the current user
        request.resource.data.status_updated_by == request.auth.uid &&
        // Ensure status_updated_at is set
        request.resource.data.status_updated_at is timestamp;
      
      // Admin users can delete cases (for data management)
      allow delete: if isAdmin();
    }
  }
}